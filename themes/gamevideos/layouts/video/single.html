{{ define "title" }}{{ .Title | markdownify }} | {{ .Site.Title }}{{ end }}

{{ define "schema-dot-org" }}
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  {{- /* Google recommends the headline be no more than 110 characters */}}
  "headline": "{{ substr .Title 0 110 }}",
  {{- with .Params.images -}}{{ range first 1 . }}
  "image": {
    "@type": "ImageObject",
    "url": "{{ . | absURL }}"
    {{- /* Don't try to get imageConfig if image param is not local */ -}}
    {{- if not (or (hasPrefix . "http://") (hasPrefix . "https://")) -}}
    {{- with (imageConfig (printf "/static/%s" .)) -}}
    ,
    "height": "{{ .Height }}",
    "width": "{{ .Width }}"
    {{- end -}}
    {{ end }}
  },
  {{- end -}}{{ end }}
  "url": "{{ printf "%s" .Permalink }}",
  "wordCount": "{{ .WordCount }}",
  {{- $ISO8601 := "2006-01-02T15:04:05-07:00" }}
  {{- if not .PublishDate.IsZero }}
  "datePublished": "{{ .PublishDate.Format $ISO8601 }}",
  {{- else }}
  "datePublished": "{{ .Date.Format $ISO8601 }}",
  {{- end }}
  {{- if not .Lastmod.IsZero }}
  "dateModified": "{{ .Lastmod.Format $ISO8601 }}",
  {{- end }}
  {{- with .Site.Social.GooglePlus }}
  "publisher": "{{ printf "%s" . }}",
  {{- end }}
  "author": {
    "@type": "Person",
    "name": "{{ .Params.author | default .Site.Params.author }}"
  }
  {{- if or (.Params.categories) (.Params.tags) -}}
  ,
  "keywords": "{{ delimit (union .Params.categories .Params.tags) ", " }}"
  {{- end }}

  {{- with .Params.description -}}
  ,
  "description": "{{ . }}"
  {{- end }}
}
</script>

{{ end }}

{{ define "main" }}
{{ $dateFormat := default "2006" (index .Site.Params "date_format") }}

<article class="blog-post">
  <header>
    <h2 class="blog-post-title"><a href="{{ .Permalink }}">{{ .Title | markdownify }}</a></h2>
    <p class="blog-post-meta"><time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">{{ .Date.Format $dateFormat }}</time> by {{ .Params.company | default .Site.Params.author }}{{ if or (.Params.categories) (.Params.tags) }} in {{ partial "meta-terms.html" . }}{{ end }}</p>
  </header>

  <video id="main-video" class="video-js" controls preload="auto" width="640" height="480"></video>
  <p id="flash-fallback"><iframe src="https://archive.org/embed/{{ .Params.archiveid}}" width="640" height="480" frameborder="0" webkitallowfullscreen="true" mozallowfullscreen="true" allowfullscreen></iframe></p>
  <script src="http://vjs.zencdn.net/6.2.4/video.js"></script>
  <script>
    var req;

    function load_video() {
      if(req.readyState !== XMLHttpRequest.DONE) {
        return;
      }

      if(req.status != 200) {
        // rip. Use archive.org embedded flash player.
        document.querySelector('#main-video').setAttribute('style', 'display: none;');
        document.querySelector('#flash-fallback').setAttribute('style', 'display: block;');
        return;
      }

      var response = JSON.parse(req.responseText);
      var have_thumb = false;
      var content = response['files'].filter(function(x) {
        if(x['format'] === 'Thumbnail') {
          if(have_thumb) return;
          have_thumb = true;
        }

        return ['Thumbnail', 'Ogg Video', 'h.264'].includes(x['format']);
      });

      var video = document.querySelector('#main-video');
      var dl_path = 'https://archive.org/download/{{ .Params.archiveid}}/';

      content.forEach(function(source) {
        if(source.format === 'Thumbnail') {
          video.setAttribute('poster', dl_path + source.name);
          return;
        }

        var source_tag = document.createElement('source');
        source_tag.setAttribute('src', dl_path + source.name);
        source_tag.setAttribute('type', `video/${source.format === 'h.264' ? 'h264' : 'ogg'}`);
        video.appendChild(source_tag);
      });

      videojs('#main-video');
    }

    function load_metadata() {
      document.querySelector('#flash-fallback').setAttribute('style', 'display: none;');
      req = new XMLHttpRequest();
      req.onreadystatechange = load_video;
      req.open('GET', 'https://archive.org/metadata/{{ .Params.archiveid}}', true);
      req.send();
    }

    load_metadata();
  </script>

  {{ .Content }}

  {{ if .IsTranslated }}
  <h4>{{ i18n "translations" }}</h4>
  <ul>
    {{ range .Translations }}
    <li>
      <a href="{{ .Permalink }}">{{ .Lang }}: {{ .Title }}{{ if .IsPage }}{{ end }}</a>
    </li>
    {{ end }}
  </ul>
  {{ end }}

  {{ if or (ne ($.Param "sharingicons") false) (.Site.DisqusShortname) }}
  <hr>
  <footer>

  {{ if (ne ($.Param "sharingicons") false) }}
  {{ partial "sharing-icons.html" . }}
  {{ end }}

  {{ if and (.Site.DisqusShortname) (ne .Params.comments false) }}
  {{ template "_internal/disqus.html" . }}
  {{ end }}
  </footer>
  {{ end }}

</article> <!-- /.blog-post -->

{{ end }}

{{- /* vim: set ts=2 sw=2 et: */}}
